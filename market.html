async function loadMarket() {
    try {
        const response = await fetch('commodities.json');
        const data = await response.json();
        const tableBody = document.getElementById('market-body');
        const treemapData = [];

        tableBody.innerHTML = '';
        
        Object.entries(data.rates).forEach(([name, priceString]) => {
            // 1. EXTRACT DATA: Convert "TTD 15.00/lb" into components
            // Matches numbers (15.00) and the unit (/lb)
            const priceMatch = priceString.match(/([\d,.]+)/);
            const rawPrice = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
            const unit = priceString.split('/').pop() || 'Unit';
            const currency = priceString.split(' ')[0] || 'TTD';

            // 2. SEASONAL LOGIC
            const isMango = name.toLowerCase().includes("mango");
            const isOutOfSeason = (rawPrice <= 0 || (isMango && rawPrice < 2.0)); 
            
            // 3. GENERATE TRENDS (Simulated for Terminal Look)
            const change = (Math.random() * 2 - 1).toFixed(2);
            const colorClass = change >= 0 ? 'price-up' : 'price-down';
            
            // 4. PREPARE CHART DATA
            treemapData.push({ 
                name: name, 
                value: isOutOfSeason ? 5 : rawPrice, // Small box if off-season
                rawPrice: rawPrice,
                change: parseFloat(change),
                isOff: isOutOfSeason
            });

            // 5. UPDATE TABLE
            tableBody.innerHTML += `
                <tr>
                    <td><strong>${name}</strong></td>
                    <td class="${isOutOfSeason ? '' : colorClass}">
                        ${isOutOfSeason ? '---' : currency + ' ' + rawPrice.toLocaleString()}
                    </td>
                    <td>
                        <span class="status-pill ${isOutOfSeason ? 'seasonal-off' : 'active'}">
                            ${isOutOfSeason ? 'Out of Season' : 'Active'}
                        </span>
                    </td>
                    <td style="color: #ccc;">${isOutOfSeason ? 'None' : (change >= 0 ? '↑' : '↓') + ' ' + Math.abs(change) + '%'}</td>
                    <td>
                        <div style="font-size: 0.7rem; color: #444;">
                            UNIT: ${unit.toUpperCase()}<br>
                            <span style="color: var(--primary)">SHA-256: VERIFIED</span>
                        </div>
                    </td>
                </tr>
            `;
        });

        // 6. RENDER TREEMAP
        const ctx = document.getElementById('treemapChart').getContext('2d');
        new Chart(ctx, {
            type: 'treemap',
            data: {
                datasets: [{
                    tree: treemapData,
                    key: 'value',
                    groups: ['name'],
                    spacing: 2,
                    borderWidth: 0,
                    backgroundColor: (ctx) => {
                        const item = ctx.dataset.data[ctx.dataIndex];
                        if (!item) return '#111';
                        const d = item._data;
                        if (d.isOff) return 'rgba(40, 40, 40, 0.9)'; // Dark grey
                        return d.change >= 0 ? 'rgba(38, 166, 154, 0.8)' : 'rgba(239, 83, 80, 0.8)';
                    },
                    labels: {
                        display: true,
                        color: 'white',
                        font: { size: 14, weight: 'bold' },
                        formatter: (ctx) => ctx.raw._data.name
                    }
                }]
            },
            options: { 
                plugins: { legend: { display: false } }, 
                maintainAspectRatio: false 
            }
        });

    } catch (e) { 
        console.error("Market Load Error", e); 
    }
}

window.onload = loadMarket;

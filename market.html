<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Françe Terminal | Market Monitor</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.0.2/dist/chartjs-chart-treemap.min.js"></script>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="market.html" style="background: var(--primary)">Market Terminal</a>
        <a href="bio-estate.html">DNA Analyzer</a>
    </nav>

    <div class="ticker-wrap">
        <div class="ticker" id="ticker-content"></div>
    </div>

    <div class="container">
        <h1>Market Analysis <span class="btn-live">LIVE</span></h1>
        <div class="chart-container">
            <canvas id="treemapChart"></canvas>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Commodity</th>
                    <th>Price (TTD)</th>
                    <th>Status</th>
                    <th>Unit</th>
                    <th>Bio-IT Logic</th>
                </tr>
            </thead>
            <tbody id="market-body"></tbody>
        </table>
    </div>

    <script>
        Chart.register(ChartTreemap);

        function loadTicker() {
            const ticker = document.getElementById('ticker-content');
            const news = [
                "MACOYA MARKET: Tenders open - Deadline Feb 13, 2026",
                "BUDGET 2026: TTD 1.13 Billion allocated to food security",
                "NAMDEVCO: Macoya trading hours Mon-Fri 3:30 AM - 10:00 AM"
            ];
            ticker.innerHTML = [...news, ...news].map(item => `<div class="ticker-item"><span>•</span> ${item}</div>`).join('');
        }

        async function loadMarket() {
            loadTicker();
            try {
                const response = await fetch('commodities.json');
                const data = await response.json();
                const tableBody = document.getElementById('market-body');
                const treemapData = [];
                tableBody.innerHTML = '';
                
                Object.entries(data.rates).forEach(([name, priceString]) => {
                    const priceMatch = priceString.match(/([\d,.]+)/);
                    const rawPrice = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
                    const isOff = rawPrice <= 0 || (name.toLowerCase().includes("mango") && rawPrice < 2);
                    const change = (Math.random() * 4 - 2).toFixed(2);

                    treemapData.push({ name, value: isOff ? 5 : rawPrice, isOff, change: parseFloat(change) });

                    tableBody.innerHTML += `
                        <tr>
                            <td><strong>${name}</strong></td>
                            <td style="color: ${isOff ? '#555' : (change >= 0 ? 'var(--up)' : 'var(--down)')}">${isOff ? '---' : priceString.split('/')[0]}</td>
                            <td><span class="status-pill ${isOff ? 'seasonal-off' : 'active'}">${isOff ? 'OFF-SEASON' : 'ACTIVE'}</span></td>
                            <td>${priceString.split('/').pop().toUpperCase()}</td>
                            <td><small style="color:#555">SHA-256: VERIFIED</small></td>
                        </tr>`;
                });

                const ctx = document.getElementById('treemapChart').getContext('2d');
                new Chart(ctx, {
                    type: 'treemap',
                    data: {
                        datasets: [{
                            tree: treemapData,
                            key: 'value',
                            groups: ['name'],
                            spacing: 1,
                            backgroundColor: (ctx) => {
                                const d = ctx.dataset.data[ctx.dataIndex]?._data;
                                if (!d) return '#111';
                                return d.isOff ? '#222' : (d.change >= 0 ? 'rgba(38, 166, 154, 0.8)' : 'rgba(239, 83, 80, 0.8)');
                            },
                            labels: { display: true, color: 'white', formatter: (ctx) => ctx.raw._data.name }
                        }]
                    },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            } catch (e) { console.error(e); }
        }
        window.onload = loadMarket;
    </script>
</body>
</html>

Object.entries(data.rates).forEach(([name, priceString]) => {
    const priceMatch = priceString.match(/([\d,.]+)/);
    const rawPrice = priceMatch ? parseFloat(priceMatch[0].replace(/,/g, '')) : 0;
    
    // Check if the price is already in USD or TTD
    let ttdPrice, usdPrice;
    if (priceString.includes("USD")) {
        usdPrice = rawPrice;
        ttdPrice = (rawPrice / 0.147).toFixed(2); // Convert USD back to TTD for display
    } else {
        ttdPrice = rawPrice;
        usdPrice = (rawPrice * 0.147).toFixed(2);
    }

    const isOff = rawPrice <= 0 || (name.toLowerCase().includes("mango") && rawPrice < 2);
    
    tableBody.innerHTML += `
        <tr>
            <td><strong>${name}</strong></td>
            <td>${isOff ? '---' : 'TTD ' + ttdPrice}</td>
            <td><span class="status-pill ${isOff ? 'seasonal-off' : 'active'}">${isOff ? 'OFF-SEASON' : 'ACTIVE'}</span></td>
            <td>${priceString.split('/').pop().toUpperCase()}</td>
            <td style="color:var(--primary)">$ ${usdPrice} USD</td>
        </tr>
    `;
});
